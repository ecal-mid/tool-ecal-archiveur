!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?b(exports):"function"==typeof define&&define.amd?define(["exports"],b):b(a.MobileDragDrop=a.MobileDragDrop||{})}(this,function(a){"use strict";function b(){var a={dragEvents:"ondragstart"in document.documentElement,draggable:"draggable"in document.documentElement,touchEvents:"ontouchstart"in document.documentElement,userAgentSupportingNativeDnD:void 0},b=!!window.chrome||/chrome/i.test(navigator.userAgent);return a.userAgentSupportingNativeDnD=!(/iPad|iPhone|iPod|Android/.test(navigator.userAgent)||b&&a.touchEvents),A&&Object.keys(a).forEach(function(a){}),a}function c(){var a=!1;try{var b=Object.defineProperty({},"passive",{get:function(){a=!0}});window.addEventListener("test",null,b)}catch(a){}return a}function d(a){if(a&&Object.keys(a).forEach(function(b){B[b]=a[b]}),!B.forceApply){var d=b();if(d.userAgentSupportingNativeDnD&&d.draggable&&d.dragEvents)return!1}return y=c(),B.holdToDrag?h("touchstart",w,!1):h("touchstart",e,!1),!0}function e(a){if(!z){var b=f(a);if(b)try{z=new J(a,B,b,g)}catch(b){throw g(B,a,3),b}}}function f(a){var b=a.target;do{if(b.draggable!==!1&&b.getAttribute&&"true"===b.getAttribute("draggable"))return b}while((b=b.parentNode)&&b!==document.body)}function g(a,b,c){if(0===c&&a.defaultActionOverride)try{a.defaultActionOverride(b),b.defaultPrevented}catch(a){}z=null}function h(a,b,c){void 0===c&&(c=!0),document.addEventListener(a,b,!!y&&{passive:c})}function i(a,b){document.removeEventListener(a,b)}function j(a){return 0===a.length?0:a.reduce(function(a,b){return b+a},0)/a.length}function k(a){return a&&a.tagName}function l(a,b){for(var c=0;c<a.changedTouches.length;c++){var d=a.changedTouches[c];if(d.identifier===b)return!0}return!1}function m(a,b,c,d,e,f,g){void 0===g&&(g=null);var h=b.changedTouches[0],i=new Event(c,{bubbles:!0,cancelable:d});i.dataTransfer=f,i.relatedTarget=g,i.screenX=h.screenX,i.screenY=h.screenY,i.clientX=h.clientX,i.clientY=h.clientY,i.pageX=h.pageX,i.pageY=h.pageY;var j=a.getBoundingClientRect();return i.offsetX=i.clientX-j.left,i.offsetY=i.clientY-j.top,i}function n(a,b,c){for(var d=[],e=[],f=0;f<b.touches.length;f++){var g=b.touches[f];d.push(g[a+"X"]),e.push(g[a+"Y"])}c.x=j(d),c.y=j(e)}function o(a,b){if(1===a.nodeType){for(var c=getComputedStyle(a),d=0;d<c.length;d++){var e=c[d];b.style.setProperty(e,c.getPropertyValue(e),c.getPropertyPriority(e))}b.style.pointerEvents="none",b.removeAttribute("id"),b.removeAttribute("class"),b.removeAttribute("draggable")}if(a.hasChildNodes())for(var d=0;d<a.childNodes.length;d++)o(a.childNodes[d],b.childNodes[d])}function p(a){var b=a.cloneNode(!0);return o(a,b),b.style.position="absolute",b.style.left="0px",b.style.top="0px",b.style.zIndex="999999",b.classList.add(G),b.classList.add(I),b}function q(a){return E.map(function(b){var c=a.style[b+"transform"];return c&&"none"!==c?c.replace(/translate\(\D*\d+[^,]*,\D*\d+[^,]*\)\s*/g,""):""})}function r(a,b,c,d,e){void 0===e&&(e=!0);var f=b.x,g=b.y;d&&(f+=d.x,g+=d.y),e&&(f-=parseInt(a.offsetWidth,10)/2,g-=parseInt(a.offsetHeight,10)/2);for(var h="translate3d("+f+"px,"+g+"px, 0)",i=0;i<E.length;i++){var j=E[i]+"transform";a.style[j]=h+" "+c[i]}}function s(a,b,c,d){var e=getComputedStyle(a);if("hidden"===e.visibility||"none"===e.display)return void d();b.classList.add(H);var f=getComputedStyle(b),g=parseFloat(f.transitionDuration);if(isNaN(g)||0===g)return void d();var h=a.getBoundingClientRect(),i={x:h.left,y:h.top};i.x+=document.body.scrollLeft||document.documentElement.scrollLeft,i.y+=document.body.scrollTop||document.documentElement.scrollTop,i.x-=parseInt(e.marginLeft,10),i.y-=parseInt(e.marginTop,10);var j=parseFloat(f.transitionDelay),k=Math.round(1e3*(g+j));r(b,i,c,void 0,!1),setTimeout(d,k)}function t(a,b){return a?a===C[0]?D[0]:0===a.indexOf(C[1])||a===C[7]?D[1]:0===a.indexOf(C[4])?D[3]:a===C[6]?D[2]:D[1]:3===b.nodeType&&"A"===b.tagName?D[3]:D[1]}function u(a,b,c,d,e,f,g){if(void 0===f&&(f=!0),void 0===g&&(g=null),A){var h=F+"debug",i=F+"event-target",j=F+"event-related-target";b.classList.add(h),b.classList.add(i),g&&(g.classList.add(h),g.classList.add(j))}var k=m(b,c,a,f,document.defaultView,e,g),l=!b.dispatchEvent(k);return d.g=0,A&&(b.classList.remove(i),g&&g.classList.remove(j)),l}function v(a,b){if(!a||a===C[7])return b;if(b===D[1]){if(0===a.indexOf(D[1]))return D[1]}else if(b===D[3]){if(0===a.indexOf(D[3])||a.indexOf("Link")>-1)return D[3]}else if(b===D[2]&&(0===a.indexOf(D[2])||a.indexOf("Move")>-1))return D[2];return D[0]}function w(a){var b=a.target,c=function(){g.off(),h.off(),i.off(),e(a)},d=function(){g.off(),h.off(),i.off(),clearTimeout(f)},f=setTimeout(c,B.holdToDrag),g=x(b,"touchend",d,this),h=x(b,"touchcancel",d,this),i=x(window,"scroll",d,this)}function x(a,b,c,d){return d&&(c=c.bind(d)),a.addEventListener(b,c),{off:function(){return a.removeEventListener(b,c)}}}var y,z,A=!1,B={iterationInterval:150},C=["none","copy","copyLink","copyMove","link","linkMove","move","all"],D=["none","copy","move","link"],E=["","-webkit-"],F="dnd-poly-",G=F+"drag-image",H=F+"snapback",I=F+"icon",J=function(){function a(a,b,c,d){this.h=a,this.i=b,this.j=c,this.k=d,this.l=0,this.m=null,this.o=null,this.p=a,this.q=a.changedTouches[0],this.s=this.t.bind(this),this.u=this.v.bind(this),h("touchmove",this.s,!1),h("touchend",this.u,!1),h("touchcancel",this.u,!1)}return a.prototype.A=function(){var a=this;this.l=1,this.B=D[0],this.C={D:{},F:void 0,g:3,G:[]},this.H={x:null,y:null},this.I={x:null,y:null};var b=this.j;if(this.J=new K(this.C,function(c,d,e){b=c,"number"!=typeof d&&"number"!=typeof e||(a.K={x:d||0,y:e||0})}),this.C.g=2,this.J.dropEffect=D[0],u("dragstart",this.j,this.p,this.C,this.J))return this.l=3,this.L(),!1;if(n("page",this.p,this.I),this.M=p(b),this.N=q(this.M),!this.K)if(this.i.dragImageOffset)this.K={x:this.i.dragImageOffset.x,y:this.i.dragImageOffset.y};else if(this.i.dragImageCenterOnTouch){var c=getComputedStyle(b);this.K={x:0-parseInt(c.marginLeft,10),y:0-parseInt(c.marginTop,10)}}else{var d=b.getBoundingClientRect(),c=getComputedStyle(b);this.K={x:d.left-this.q.clientX-parseInt(c.marginLeft,10)+d.width/2,y:d.top-this.q.clientY-parseInt(c.marginTop,10)+d.height/2}}return r(this.M,this.I,this.N,this.K,this.i.dragImageCenterOnTouch),document.body.appendChild(this.M),this.O=setInterval(function(){a.P||(a.P=!0,a.R(),a.P=!1)},this.i.iterationInterval),!0},a.prototype.L=function(){this.O&&(clearInterval(this.O),this.O=null),i("touchmove",this.s),i("touchend",this.u),i("touchcancel",this.u),this.M&&(this.M.parentNode.removeChild(this.M),this.M=null),this.k(this.i,this.p,this.l)},a.prototype.t=function(a){var b=this;if(l(a,this.q.identifier)!==!1){if(this.p=a,0===this.l){var c=void 0;if(this.i.dragStartConditionOverride)try{c=this.i.dragStartConditionOverride(a)}catch(a){c=!1}else c=1===a.touches.length;return c?void(this.A()===!0&&(this.h.preventDefault(),a.preventDefault())):void this.L()}if(a.preventDefault(),n("client",a,this.H),n("page",a,this.I),this.i.dragImageTranslateOverride)try{var d=!1;if(this.i.dragImageTranslateOverride(a,{x:this.H.x,y:this.H.y},this.m,function(a,c){b.M&&(d=!0,b.H.x+=a,b.H.y+=c,b.I.x+=a,b.I.y+=c,r(b.M,b.I,b.N,b.K,b.i.dragImageCenterOnTouch))}),d)return}catch(a){}r(this.M,this.I,this.N,this.K,this.i.dragImageCenterOnTouch)}},a.prototype.v=function(a){if(l(a,this.q.identifier)!==!1){if(this.i.dragImageTranslateOverride)try{this.i.dragImageTranslateOverride(void 0,void 0,void 0,function(){})}catch(a){}if(0===this.l)return void this.L();a.preventDefault(),this.l="touchcancel"===a.type?3:2}},a.prototype.R=function(){var a=this;if(A)var b=F+"debug",c=F+"immediate-user-selection",d=F+"current-drop-target";var e=this.B;this.C.g=3,this.J.dropEffect=D[0];var f=u("drag",this.j,this.p,this.C,this.J);if(f&&(this.B=D[0]),f||2===this.l||3===this.l){var g=this.S(this.l);return g?void s(this.j,this.M,this.N,function(){a.T()}):void this.T()}var h=document.elementFromPoint(this.H.x,this.H.y),i=this.o;h!==this.m&&h!==this.o&&(A&&(this.m&&this.m.classList.remove(c),h&&(h.classList.add(b),h.classList.add(c))),this.m=h,null!==this.o&&(this.C.g=3,this.J.dropEffect=D[0],u("dragexit",this.o,this.p,this.C,this.J,!1)),null===this.m?this.o=this.m:(this.C.g=3,this.J.dropEffect=t(this.C.F,this.j),u("dragenter",this.m,this.p,this.C,this.J)?(this.o=this.m,this.B=v(this.J.effectAllowed,this.J.dropEffect)):this.m!==document.body&&(this.o=document.body))),i!==this.o&&k(i)&&(A&&i.classList.remove(d),this.C.g=3,this.J.dropEffect=D[0],u("dragleave",i,this.p,this.C,this.J,!1,this.o)),k(this.o)&&(A&&(this.o.classList.add(b),this.o.classList.add(d)),this.C.g=3,this.J.dropEffect=t(this.C.F,this.j),u("dragover",this.o,this.p,this.C,this.J)===!1?this.B=D[0]:this.B=v(this.J.effectAllowed,this.J.dropEffect)),e!==this.B&&this.M.classList.remove(F+e);var j=F+this.B;this.M.classList.contains(j)===!1&&this.M.classList.add(j)},a.prototype.S=function(a){if(A){var b=F+"immediate-user-selection",c=F+"current-drop-target";this.o&&this.o.classList.remove(c),this.m&&this.m.classList.remove(b)}var d=this.B===D[0]||null===this.o||3===a;return d?k(this.o)&&(this.C.g=3,this.J.dropEffect=D[0],u("dragleave",this.o,this.p,this.C,this.J,!1)):k(this.o)&&(this.C.g=1,this.J.dropEffect=this.B,u("drop",this.o,this.p,this.C,this.J)===!0?this.B=this.J.dropEffect:this.B=D[0]),d},a.prototype.T=function(){this.C.g=3,this.J.dropEffect=this.B,u("dragend",this.j,this.p,this.C,this.J,!1),this.l=2,this.L()},a}(),K=function(){function a(a,b){this.U=a,this.V=b,this.W=D[0]}return Object.defineProperty(a.prototype,"types",{get:function(){if(0!==this.U.g)return Object.freeze(this.U.G)},enumerable:!0,configurable:!0}),a.prototype.setData=function(a,b){if(2===this.U.g){if(a.indexOf(" ")>-1)throw new Error("illegal arg: type contains space");this.U.D[a]=b,this.U.G.indexOf(a)===-1&&this.U.G.push(a)}},a.prototype.getData=function(a){if(1===this.U.g||2===this.U.g)return this.U.D[a]||""},a.prototype.clearData=function(a){if(2===this.U.g){if(a&&this.U.D[a]){delete this.U.D[a];var b=this.U.G.indexOf(a);return void(b>-1&&this.U.G.splice(b,1))}this.U.D={},this.U.G=[]}},a.prototype.setDragImage=function(a,b,c){2===this.U.g&&this.V(a,b,c)},Object.defineProperty(a.prototype,"effectAllowed",{get:function(){return this.U.F},set:function(a){2===this.U.g&&C.indexOf(a)>-1&&(this.U.F=a)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"dropEffect",{get:function(){return this.W},set:function(a){0!==this.U.g&&C.indexOf(a)>-1&&(this.W=a)},enumerable:!0,configurable:!0}),a}();a.polyfill=d,Object.defineProperty(a,"__esModule",{value:!0})});!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,t.qwest=e()}}(function(){var e;return function t(e,n,r){function o(s,a){if(!n[s]){if(!e[s]){var u="function"==typeof require&&require;if(!a&&u)return u(s,!0);if(i)return i(s,!0);var p=new Error("Cannot find module '"+s+"'");throw p.code="MODULE_NOT_FOUND",p}var f=n[s]={exports:{}};e[s][0].call(f.exports,function(t){var n=e[s][1][t];return o(n?n:t)},f,f.exports,t,e,n,r)}return n[s].exports}for(var i="function"==typeof require&&require,s=0;s<r.length;s++)o(r[s]);return o}({1:[function(t,n,r){!function(t){"use strict";var r=function(e){var t=function(e,t,n){n="function"==typeof n?n():null===n?"":void 0===n?"":n,e[e.length]=encodeURIComponent(t)+"="+encodeURIComponent(n)},n=function(e,r,o){var i,s,a;if("[object Array]"===Object.prototype.toString.call(r))for(i=0,s=r.length;s>i;i++)n(e+"["+("object"==typeof r[i]?i:"")+"]",r[i],o);else if(r&&"[object Object]"===r.toString())for(a in r)r.hasOwnProperty(a)&&(e?n(e+"["+a+"]",r[a],o,t):n(a,r[a],o,t));else if(e)t(o,e,r);else for(a in r)t(o,a,r[a]);return o};return n("",e,[]).join("&").replace(/%20/g,"+")};"object"==typeof n&&"object"==typeof n.exports?n.exports=r:"function"==typeof e&&e.amd?e([],function(){return r}):t.param=r}(this)},{}],2:[function(e,t,n){!function(e){function t(e){return"function"==typeof e}function n(e){return"object"==typeof e}function r(e){"undefined"!=typeof setImmediate?setImmediate(e):"undefined"!=typeof process&&process.nextTick?process.nextTick(e):setTimeout(e,0)}var o;e[0][e[1]]=function i(e){var s,a=[],u=[],p=function(e,t){return null==s&&null!=e&&(s=e,a=t,u.length&&r(function(){for(var e=0;e<u.length;e++)u[e]()})),s};return p.then=function(p,f){var c=i(e),l=function(){function e(r){var i,s=0;try{if(r&&(n(r)||t(r))&&t(i=r.then)){if(r===c)throw new TypeError;i.call(r,function(){s++||e.apply(o,arguments)},function(e){s++||c(!1,[e])})}else c(!0,arguments)}catch(a){s++||c(!1,[a])}}try{var r=s?p:f;t(r)?e(r.apply(o,a||[])):c(s,a)}catch(i){c(!1,[i])}};return null!=s?r(l):u.push(l),c},e&&(p=e(p)),p}}("undefined"==typeof t?[window,"pinkySwear"]:[t,"exports"])},{}],qwest:[function(e,t,n){t.exports=function(){var t="undefined"!=typeof window?window:self,n=e("pinkyswear"),r=e("jquery-param"),o={},i="json",s="post",a=null,u=0,p=[],f=t.XMLHttpRequest?function(){return new t.XMLHttpRequest}:function(){return new ActiveXObject("Microsoft.XMLHTTP")},c=""===f().responseType,l=function(e,l,d,y,m){e=e.toUpperCase(),d=d||null,y=y||{};for(var h in o)if(!(h in y))if("object"==typeof o[h]&&"object"==typeof y[h])for(var T in o[h])y[h][T]=o[h][T];else y[h]=o[h];var w,g,v,x,b,j=!1,q=!1,C=!1,O=0,D={},E={text:"*/*",xml:"text/xml",json:"application/json",post:"application/x-www-form-urlencoded",document:"text/html"},M={text:"*/*",xml:"application/xml; q=1.0, text/xml; q=0.8, */*; q=0.1",json:"application/json; q=1.0, text/*; q=0.8, */*; q=0.1"},X=!1,L=n(function(n){return n.abort=function(){C||(g&&4!=g.readyState&&g.abort(),X&&(--u,X=!1),C=!0)},n.send=function(){if(!X){if(u==a)return void p.push(n);if(C)return void(p.length&&p.shift().send());if(++u,X=!0,g=f(),w&&("withCredentials"in g||!t.XDomainRequest||(g=new XDomainRequest,q=!0,"GET"!=e&&"POST"!=e&&(e="POST"))),q?g.open(e,l):(g.open(e,l,y.async,y.user,y.password),c&&y.async&&(g.withCredentials=y.withCredentials)),!q)for(var r in D)D[r]&&g.setRequestHeader(r,D[r]);if(c&&"auto"!=y.responseType)try{g.responseType=y.responseType,j=g.responseType==y.responseType}catch(o){}c||q?(g.onload=R,g.onerror=S,q&&(g.onprogress=function(){})):g.onreadystatechange=function(){4==g.readyState&&R()},y.async?"timeout"in g?(g.timeout=y.timeout,g.ontimeout=k):v=setTimeout(k,y.timeout):q&&(g.ontimeout=function(){}),"auto"!=y.responseType&&"overrideMimeType"in g&&g.overrideMimeType(E[y.responseType]),m&&m(g),q?setTimeout(function(){g.send("GET"!=e?d:null)},0):g.send("GET"!=e?d:null)}},n}),R=function(){var e;if(X=!1,clearTimeout(v),p.length&&p.shift().send(),!C){--u;try{if(j&&"response"in g&&null!==g.response)b=g.response;else{if(e=y.responseType,"auto"==e)if(q)e=i;else{var n=g.getResponseHeader("Content-Type")||"";e=n.indexOf(E.json)>-1?"json":n.indexOf(E.xml)>-1?"xml":"text"}switch(e){case"json":if(g.responseText.length)try{b="JSON"in t?JSON.parse(g.responseText):new Function("return ("+g.responseText+")")()}catch(r){throw"Error while parsing JSON body : "+r}break;case"xml":try{t.DOMParser?b=(new DOMParser).parseFromString(g.responseText,"text/xml"):(b=new ActiveXObject("Microsoft.XMLDOM"),b.async="false",b.loadXML(g.responseText))}catch(r){b=void 0}if(!b||!b.documentElement||b.getElementsByTagName("parsererror").length)throw"Invalid XML";break;default:b=g.responseText}}if("status"in g&&!/^2|1223/.test(g.status))throw g.status+" ("+g.statusText+")";L(!0,[g,b])}catch(r){L(!1,[r,g,b])}}},S=function(e){C||(e="string"==typeof e?e:"Connection aborted",L.abort(),L(!1,[new Error(e),g,null]))},k=function(){C||(y.attempts&&++O==y.attempts?S("Timeout ("+l+")"):(g.abort(),X=!1,L.send()))};if(y.async="async"in y?!!y.async:!0,y.cache="cache"in y?!!y.cache:!1,y.dataType="dataType"in y?y.dataType.toLowerCase():s,y.responseType="responseType"in y?y.responseType.toLowerCase():"auto",y.user=y.user||"",y.password=y.password||"",y.withCredentials=!!y.withCredentials,y.timeout="timeout"in y?parseInt(y.timeout,10):3e4,y.attempts="attempts"in y?parseInt(y.attempts,10):1,x=l.match(/\/\/(.+?)\//),w=x&&(x[1]?x[1]!=location.host:!1),"ArrayBuffer"in t&&d instanceof ArrayBuffer?y.dataType="arraybuffer":"Blob"in t&&d instanceof Blob?y.dataType="blob":"Document"in t&&d instanceof Document?y.dataType="document":"FormData"in t&&d instanceof FormData&&(y.dataType="formdata"),null!==d)switch(y.dataType){case"json":d=JSON.stringify(d);break;case"post":d=r(d)}if(y.headers){var P=function(e,t,n){return t+n.toUpperCase()};for(x in y.headers)D[x.replace(/(^|-)([^-])/g,P)]=y.headers[x]}return"Content-Type"in D||"GET"==e||y.dataType in E&&E[y.dataType]&&(D["Content-Type"]=E[y.dataType]),D.Accept||(D.Accept=y.responseType in M?M[y.responseType]:"*/*"),w||"X-Requested-With"in D||(D["X-Requested-With"]="XMLHttpRequest"),y.cache||"Cache-Control"in D||(D["Cache-Control"]="no-cache"),"GET"==e&&d&&"string"==typeof d&&(l+=(/\?/.test(l)?"&":"?")+d),y.async&&L.send(),L},d=function(e){var t=[],r=0,o=[];return n(function(n){var i=-1,s=function(e){return function(s,a,u,p){var f=++i;return++r,t.push(l(e,n.base+s,a,u,p).then(function(e,t){o[f]=arguments,--r||n(!0,1==o.length?o[0]:[o])},function(){n(!1,arguments)})),n}};n.get=s("GET"),n.post=s("POST"),n.put=s("PUT"),n["delete"]=s("DELETE"),n["catch"]=function(e){return n.then(null,e)},n.complete=function(e){var t=function(){e()};return n.then(t,t)},n.map=function(e,t,n,r,o){return s(e.toUpperCase()).call(this,t,n,r,o)};for(var a in e)a in n||(n[a]=e[a]);return n.send=function(){for(var e=0,r=t.length;r>e;++e)t[e].send();return n},n.abort=function(){for(var e=0,r=t.length;r>e;++e)t[e].abort();return n},n})},y={base:"",get:function(){return d(y).get.apply(this,arguments)},post:function(){return d(y).post.apply(this,arguments)},put:function(){return d(y).put.apply(this,arguments)},delete:function(){return d(y)["delete"].apply(this,arguments)},map:function(){return d(y).map.apply(this,arguments)},xhr2:c,limit:function(e){return a=e,y},setDefaultOptions:function(e){return o=e,y},setDefaultXdrResponseType:function(e){return i=e.toLowerCase(),y},setDefaultDataType:function(e){return s=e.toLowerCase(),y},getOpenRequests:function(){return u}};return y}()},{"jquery-param":1,pinkyswear:2}]},{},[1,2])("qwest")});(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){"use strict";var fs=require("fs"),utils=require("./utils"),scopeOptionWarned=false,_VERSION_STRING=require("../package.json").version,_DEFAULT_DELIMITER="%",_DEFAULT_LOCALS_NAME="locals",_REGEX_STRING="(<%%|<%=|<%-|<%_|<%#|<%|%>|-%>|_%>)",_OPTS=["cache","filename","delimiter","scope","context","debug","compileDebug","client","_with","rmWhitespace","strict","localsName"],_TRAILING_SEMCOL=/;\s*$/,_BOM=/^\uFEFF/;exports.cache=utils.cache;exports.localsName=_DEFAULT_LOCALS_NAME;exports.resolveInclude=function(name,filename){var path=require("path"),dirname=path.dirname,extname=path.extname,resolve=path.resolve,includePath=resolve(dirname(filename),name),ext=extname(name);if(!ext){includePath+=".ejs"}return includePath};function handleCache(options,template){var fn,path=options.filename,hasTemplate=arguments.length>1;if(options.cache){if(!path){throw new Error("cache option requires a filename")}fn=exports.cache.get(path);if(fn){return fn}if(!hasTemplate){template=fs.readFileSync(path).toString().replace(_BOM,"")}}else if(!hasTemplate){if(!path){throw new Error("Internal EJS error: no file name or template "+"provided")}template=fs.readFileSync(path).toString().replace(_BOM,"")}fn=exports.compile(template,options);if(options.cache){exports.cache.set(path,fn)}return fn}function includeFile(path,options){var opts=utils.shallowCopy({},options);if(!opts.filename){throw new Error("`include` requires the 'filename' option.")}opts.filename=exports.resolveInclude(path,opts.filename);return handleCache(opts)}function includeSource(path,options){var opts=utils.shallowCopy({},options),includePath,template;if(!opts.filename){throw new Error("`include` requires the 'filename' option.")}includePath=exports.resolveInclude(path,opts.filename);template=fs.readFileSync(includePath).toString().replace(_BOM,"");opts.filename=includePath;var templ=new Template(template,opts);templ.generateSource();return templ.source}function rethrow(err,str,filename,lineno){var lines=str.split("\n"),start=Math.max(lineno-3,0),end=Math.min(lines.length,lineno+3);var context=lines.slice(start,end).map(function(line,i){var curr=i+start+1;return(curr==lineno?" >> ":"    ")+curr+"| "+line}).join("\n");err.path=filename;err.message=(filename||"ejs")+":"+lineno+"\n"+context+"\n\n"+err.message;throw err}function cpOptsInData(data,opts){_OPTS.forEach(function(p){if(typeof data[p]!="undefined"){opts[p]=data[p]}})}exports.compile=function compile(template,opts){var templ;if(opts&&opts.scope){if(!scopeOptionWarned){console.warn("`scope` option is deprecated and will be removed in EJS 3");scopeOptionWarned=true}if(!opts.context){opts.context=opts.scope}delete opts.scope}templ=new Template(template,opts);return templ.compile()};exports.render=function(template,data,opts){data=data||{};opts=opts||{};var fn;if(arguments.length==2){cpOptsInData(data,opts)}return handleCache(opts,template)(data)};exports.renderFile=function(){var args=Array.prototype.slice.call(arguments),path=args.shift(),cb=args.pop(),data=args.shift()||{},opts=args.pop()||{},result;opts=utils.shallowCopy({},opts);if(arguments.length==3){if(data.settings&&data.settings["view options"]){cpOptsInData(data.settings["view options"],opts)}else{cpOptsInData(data,opts)}}opts.filename=path;try{result=handleCache(opts)(data)}catch(err){return cb(err)}return cb(null,result)};exports.clearCache=function(){exports.cache.reset()};function Template(text,opts){opts=opts||{};var options={};this.templateText=text;this.mode=null;this.truncate=false;this.currentLine=1;this.source="";this.dependencies=[];options.client=opts.client||false;options.escapeFunction=opts.escape||utils.escapeXML;options.compileDebug=opts.compileDebug!==false;options.debug=!!opts.debug;options.filename=opts.filename;options.delimiter=opts.delimiter||exports.delimiter||_DEFAULT_DELIMITER;options.strict=opts.strict||false;options.context=opts.context;options.cache=opts.cache||false;options.rmWhitespace=opts.rmWhitespace;options.localsName=opts.localsName||exports.localsName||_DEFAULT_LOCALS_NAME;if(options.strict){options._with=false}else{options._with=typeof opts._with!="undefined"?opts._with:true}this.opts=options;this.regex=this.createRegex()}Template.modes={EVAL:"eval",ESCAPED:"escaped",RAW:"raw",COMMENT:"comment",LITERAL:"literal"};Template.prototype={createRegex:function(){var str=_REGEX_STRING,delim=utils.escapeRegExpChars(this.opts.delimiter);str=str.replace(/%/g,delim);return new RegExp(str)},compile:function(){var src,fn,opts=this.opts,prepended="",appended="",escape=opts.escapeFunction;if(opts.rmWhitespace){this.templateText=this.templateText.replace(/\r/g,"").replace(/^\s+|\s+$/gm,"")}this.templateText=this.templateText.replace(/[ \t]*<%_/gm,"<%_").replace(/_%>[ \t]*/gm,"_%>");if(!this.source){this.generateSource();prepended+="  var __output = [], __append = __output.push.bind(__output);"+"\n";if(opts._with!==false){prepended+="  with ("+opts.localsName+" || {}) {"+"\n";appended+="  }"+"\n"}appended+='  return __output.join("");'+"\n";this.source=prepended+this.source+appended}if(opts.compileDebug){src="var __line = 1"+"\n"+"  , __lines = "+JSON.stringify(this.templateText)+"\n"+"  , __filename = "+(opts.filename?JSON.stringify(opts.filename):"undefined")+";"+"\n"+"try {"+"\n"+this.source+"} catch (e) {"+"\n"+"  rethrow(e, __lines, __filename, __line);"+"\n"+"}"+"\n"}else{src=this.source}if(opts.debug){console.log(src)}if(opts.client){src="escape = escape || "+escape.toString()+";"+"\n"+src;if(opts.compileDebug){src="rethrow = rethrow || "+rethrow.toString()+";"+"\n"+src}}if(opts.strict){src='"use strict";\n'+src}try{fn=new Function(opts.localsName+", escape, include, rethrow",src)}catch(e){if(e instanceof SyntaxError){if(opts.filename){e.message+=" in "+opts.filename}e.message+=" while compiling ejs"}throw e}if(opts.client){fn.dependencies=this.dependencies;return fn}var returnedFn=function(data){var include=function(path,includeData){var d=utils.shallowCopy({},data);if(includeData){d=utils.shallowCopy(d,includeData)}return includeFile(path,opts)(d)};return fn.apply(opts.context,[data||{},escape,include,rethrow])};returnedFn.dependencies=this.dependencies;return returnedFn},generateSource:function(){var self=this,matches=this.parseTemplateText(),d=this.opts.delimiter;if(matches&&matches.length){if(this.opts.compileDebug&&this.opts.filename){this.source="    ; __lines = "+JSON.stringify(this.templateText)+"\n";this.source+='    ; __filename = "'+this.opts.filename.replace(/\\/g,"/")+'"\n'}matches.forEach(function(line,index){var opening,closing,include,includeOpts,includeSrc;if(line.indexOf("<"+d)===0&&line.indexOf("<"+d+d)!==0){closing=matches[index+2];if(!(closing==d+">"||closing=="-"+d+">"||closing=="_"+d+">")){throw new Error('Could not find matching close tag for "'+line+'".')}}if(include=line.match(/^\s*include\s+(\S+)/)){opening=matches[index-1];if(opening&&(opening=="<"+d||opening=="<"+d+"-"||opening=="<"+d+"_")){includeOpts=utils.shallowCopy({},self.opts);includeSrc=includeSource(include[1],includeOpts);includeSrc="    ; (function(){"+"\n"+includeSrc+"    ; })()"+"\n";self.source+=includeSrc;self.dependencies.push(exports.resolveInclude(include[1],includeOpts.filename));return}}self.scanLine(line)})}},parseTemplateText:function(){var str=this.templateText,pat=this.regex,result=pat.exec(str),arr=[],firstPos,lastPos;while(result){firstPos=result.index;lastPos=pat.lastIndex;if(firstPos!==0){arr.push(str.substring(0,firstPos));str=str.slice(firstPos)}arr.push(result[0]);str=str.slice(result[0].length);result=pat.exec(str)}if(str){arr.push(str)}return arr},scanLine:function(line){var self=this,d=this.opts.delimiter,newLineCount=0;function _addOutput(){if(self.truncate){line=line.replace(/^(?:\r\n|\r|\n)/,"");self.truncate=false}else if(self.opts.rmWhitespace){line=line.replace(/^\n/,"")}if(!line){return}line=line.replace(/\\/g,"\\\\");line=line.replace(/\n/g,"\\n");line=line.replace(/\r/g,"\\r");line=line.replace(/"/g,'\\"');self.source+='    ; __append("'+line+'")'+"\n"}newLineCount=line.split("\n").length-1;switch(line){case"<"+d:case"<"+d+"_":this.mode=Template.modes.EVAL;break;case"<"+d+"=":this.mode=Template.modes.ESCAPED;break;case"<"+d+"-":this.mode=Template.modes.RAW;break;case"<"+d+"#":this.mode=Template.modes.COMMENT;break;case"<"+d+d:this.mode=Template.modes.LITERAL;this.source+='    ; __append("'+line.replace("<"+d+d,"<"+d)+'")'+"\n";break;case d+">":case"-"+d+">":case"_"+d+">":if(this.mode==Template.modes.LITERAL){_addOutput()}this.mode=null;this.truncate=line.indexOf("-")===0||line.indexOf("_")===0;break;default:if(this.mode){switch(this.mode){case Template.modes.EVAL:case Template.modes.ESCAPED:case Template.modes.RAW:if(line.lastIndexOf("//")>line.lastIndexOf("\n")){line+="\n"}}switch(this.mode){case Template.modes.EVAL:this.source+="    ; "+line+"\n";break;case Template.modes.ESCAPED:this.source+="    ; __append(escape("+line.replace(_TRAILING_SEMCOL,"").trim()+"))"+"\n";break;case Template.modes.RAW:this.source+="    ; __append("+line.replace(_TRAILING_SEMCOL,"").trim()+")"+"\n";break;case Template.modes.COMMENT:break;case Template.modes.LITERAL:_addOutput();break}}else{_addOutput()}}if(self.opts.compileDebug&&newLineCount){this.currentLine+=newLineCount;this.source+="    ; __line = "+this.currentLine+"\n"}}};exports.escapeXML=utils.escapeXML;exports.__express=exports.renderFile;if(require.extensions){require.extensions[".ejs"]=function(module,filename){filename=filename||module.filename;var options={filename:filename,client:true},template=fs.readFileSync(filename).toString(),fn=exports.compile(template,options);module._compile("module.exports = "+fn.toString()+";",filename)}}exports.VERSION=_VERSION_STRING;if(typeof window!="undefined"){window.ejs=exports}},{"../package.json":6,"./utils":2,fs:3,path:4}],2:[function(require,module,exports){"use strict";var regExpChars=/[|\\{}()[\]^$+*?.]/g;exports.escapeRegExpChars=function(string){if(!string){return""}return String(string).replace(regExpChars,"\\$&")};var _ENCODE_HTML_RULES={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&#34;","'":"&#39;"},_MATCH_HTML=/[&<>\'"]/g;function encode_char(c){return _ENCODE_HTML_RULES[c]||c}var escapeFuncStr="var _ENCODE_HTML_RULES = {\n"+'      "&": "&amp;"\n'+'    , "<": "&lt;"\n'+'    , ">": "&gt;"\n'+'    , \'"\': "&#34;"\n'+'    , "\'": "&#39;"\n'+"    }\n"+"  , _MATCH_HTML = /[&<>'\"]/g;\n"+"function encode_char(c) {\n"+"  return _ENCODE_HTML_RULES[c] || c;\n"+"};\n";exports.escapeXML=function(markup){return markup==undefined?"":String(markup).replace(_MATCH_HTML,encode_char)};exports.escapeXML.toString=function(){return Function.prototype.toString.call(this)+";\n"+escapeFuncStr};exports.shallowCopy=function(to,from){from=from||{};for(var p in from){to[p]=from[p]}return to};exports.cache={_data:{},set:function(key,val){this._data[key]=val},get:function(key){return this._data[key]},reset:function(){this._data={}}}},{}],3:[function(require,module,exports){},{}],4:[function(require,module,exports){(function(process){function normalizeArray(parts,allowAboveRoot){var up=0;for(var i=parts.length-1;i>=0;i--){var last=parts[i];if(last==="."){parts.splice(i,1)}else if(last===".."){parts.splice(i,1);up++}else if(up){parts.splice(i,1);up--}}if(allowAboveRoot){for(;up--;up){parts.unshift("..")}}return parts}var splitPathRe=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/;var splitPath=function(filename){return splitPathRe.exec(filename).slice(1)};exports.resolve=function(){var resolvedPath="",resolvedAbsolute=false;for(var i=arguments.length-1;i>=-1&&!resolvedAbsolute;i--){var path=i>=0?arguments[i]:process.cwd();if(typeof path!=="string"){throw new TypeError("Arguments to path.resolve must be strings")}else if(!path){continue}resolvedPath=path+"/"+resolvedPath;resolvedAbsolute=path.charAt(0)==="/"}resolvedPath=normalizeArray(filter(resolvedPath.split("/"),function(p){return!!p}),!resolvedAbsolute).join("/");return(resolvedAbsolute?"/":"")+resolvedPath||"."};exports.normalize=function(path){var isAbsolute=exports.isAbsolute(path),trailingSlash=substr(path,-1)==="/";path=normalizeArray(filter(path.split("/"),function(p){return!!p}),!isAbsolute).join("/");if(!path&&!isAbsolute){path="."}if(path&&trailingSlash){path+="/"}return(isAbsolute?"/":"")+path};exports.isAbsolute=function(path){return path.charAt(0)==="/"};exports.join=function(){var paths=Array.prototype.slice.call(arguments,0);return exports.normalize(filter(paths,function(p,index){if(typeof p!=="string"){throw new TypeError("Arguments to path.join must be strings")}return p}).join("/"))};exports.relative=function(from,to){from=exports.resolve(from).substr(1);to=exports.resolve(to).substr(1);function trim(arr){var start=0;for(;start<arr.length;start++){if(arr[start]!=="")break}var end=arr.length-1;for(;end>=0;end--){if(arr[end]!=="")break}if(start>end)return[];return arr.slice(start,end-start+1)}var fromParts=trim(from.split("/"));var toParts=trim(to.split("/"));var length=Math.min(fromParts.length,toParts.length);var samePartsLength=length;for(var i=0;i<length;i++){if(fromParts[i]!==toParts[i]){samePartsLength=i;break}}var outputParts=[];for(var i=samePartsLength;i<fromParts.length;i++){outputParts.push("..")}outputParts=outputParts.concat(toParts.slice(samePartsLength));return outputParts.join("/")};exports.sep="/";exports.delimiter=":";exports.dirname=function(path){var result=splitPath(path),root=result[0],dir=result[1];if(!root&&!dir){return"."}if(dir){dir=dir.substr(0,dir.length-1)}return root+dir};exports.basename=function(path,ext){var f=splitPath(path)[2];if(ext&&f.substr(-1*ext.length)===ext){f=f.substr(0,f.length-ext.length)}return f};exports.extname=function(path){return splitPath(path)[3]};function filter(xs,f){if(xs.filter)return xs.filter(f);var res=[];for(var i=0;i<xs.length;i++){if(f(xs[i],i,xs))res.push(xs[i])}return res}var substr="ab".substr(-1)==="b"?function(str,start,len){return str.substr(start,len)}:function(str,start,len){if(start<0)start=str.length+start;return str.substr(start,len)}}).call(this,require("_process"))},{_process:5}],5:[function(require,module,exports){var process=module.exports={};var queue=[];var draining=false;function drainQueue(){if(draining){return}draining=true;var currentQueue;var len=queue.length;while(len){currentQueue=queue;queue=[];var i=-1;while(++i<len){currentQueue[i]()}len=queue.length}draining=false}process.nextTick=function(fun){queue.push(fun);if(!draining){setTimeout(drainQueue,0)}};process.title="browser";process.browser=true;process.env={};process.argv=[];process.version="";process.versions={};function noop(){}process.on=noop;process.addListener=noop;process.once=noop;process.off=noop;process.removeListener=noop;process.removeAllListeners=noop;process.emit=noop;process.binding=function(name){throw new Error("process.binding is not supported")};process.cwd=function(){return"/"};process.chdir=function(dir){throw new Error("process.chdir is not supported")};process.umask=function(){return 0}},{}],6:[function(require,module,exports){module.exports={name:"ejs",description:"Embedded JavaScript templates",keywords:["template","engine","ejs"],version:"2.4.1",author:"Matthew Eernisse <mde@fleegix.org> (http://fleegix.org)",contributors:["Timothy Gu <timothygu99@gmail.com> (https://timothygu.github.io)"],license:"Apache-2.0",main:"./lib/ejs.js",repository:{type:"git",url:"git://github.com/mde/ejs.git"},bugs:"https://github.com/mde/ejs/issues",homepage:"https://github.com/mde/ejs",dependencies:{},devDependencies:{browserify:"^8.0.3",istanbul:"~0.3.5",jake:"^8.0.0",jsdoc:"^3.3.0-beta1","lru-cache":"^2.5.0",mocha:"^2.1.0",rimraf:"^2.2.8","uglify-js":"^2.4.16"},engines:{node:">=0.10.0"},scripts:{test:"mocha",sample:"npm install express && node sample/index.js",coverage:"istanbul cover node_modules/mocha/bin/_mocha",doc:"rimraf out && jsdoc -c jsdoc.json lib/* docs/jsdoc/*",devdoc:"rimraf out && jsdoc -p -c jsdoc.json lib/* docs/jsdoc/*"}}},{}]},{},[1]);function isAdvancedUploadSupported(){let div=document.createElement("div");return("draggable"in div||"ondragstart"in div&&"ondrop"in div)&&"FormData"in window&&"FileReader"in window}function generateGUUID(){const s4=function(){return((1+Math.random())*65536|0).toString(16).substring(1)};return s4()+s4()+"-"+s4()+"-"+s4()+"-"+s4()+"-"+s4()+s4()+s4()}const api={upload:data=>{return new Promise((resolve,error)=>{qwest.post("/api/upload",data).then((xhr,data)=>resolve(JSON.parse(data))).catch(error)})},update:(year,assignmentId,data)=>{return new Promise((resolve,error)=>{qwest.post(`/api/a/${year}/${assignmentId}`,data,{dataType:"json"}).then((xhr,resp)=>resolve(JSON.parse(resp))).catch(error)})},notify:(type,data)=>{return new Promise((resolve,error)=>{qwest.post(`/api/notify/${type}`,data,{dataType:"json"}).then((xhr,resp)=>resolve(JSON.parse(resp))).catch(error)})}};const config={apiKey:"AIzaSyCqNMEwaXwtkgo3GuCbq6FjNpkj0o1I3TY",authDomain:"ecal-archiveur.firebaseapp.com",databaseURL:"https://ecal-archiveur.firebaseio.com",projectId:"ecal-archiveur",storageBucket:"ecal-archiveur.appspot.com",messagingSenderId:"457121585616"};firebase.initializeApp(config);class UploadBox{constructor(el){this.el=el;this.droppedFiles=null;this.isAdvancedUpload=isAdvancedUploadSupported();this.errorEl=el.querySelector(".box__error");if(this.isAdvancedUpload){this.el.classList.add("has-advanced-upload")}for(let ev of["dragover","dragenter"]){this.el.addEventListener(ev,this.dragEnter.bind(this),false)}for(let ev of["dragleave","dragend","drop"]){this.el.addEventListener(ev,this.dragLeave.bind(this),false)}this.el.addEventListener("drop",this.drop.bind(this),false);this.el.addEventListener("submit",this.submitForm.bind(this),false);this.el.addEventListener("click",()=>{this.el.querySelector("input.box__file").click()},false);this.inputEl=this.el.querySelector("input.box__file");this.inputEl.addEventListener("change",this.submitForm.bind(this),false)}disableDefault(ev){ev.preventDefault();ev.stopPropagation()}dragEnter(ev){this.disableDefault(ev);this.el.classList.add("is-dragover")}dragLeave(ev){this.disableDefault(ev);this.el.classList.remove("is-dragover")}drop(ev){this.disableDefault(ev);this.droppedFiles=ev.dataTransfer.files;this.submitForm()}submitForm(){if(this.el.classList.contains("is-uploading")){return}this.el.classList.add("is-uploading");this.el.classList.remove("is-error");if(this.isAdvancedUpload){let data=new FormData(this.el);if(data.get("file").name==""){if(this.droppedFiles){data.set("file",this.droppedFiles[0])}else{let err=new Error("No file selected.");this.onFileUploadError(err)}}let path=assignment.year+"/"+assignment.docId;if(!this.el.classList.contains("is-assignment")){path+="/"+assignment.groupId}data.set("path",path);api.upload(data).then(this.onFileUploaded.bind(this)).catch(this.onFileUploadError.bind(this))}else{}}reset(){this.droppedFiles=null;this.el.classList.remove("is-uploading");this.inputEl.value=""}onFileUploaded(response){this.reset();if(response.error){this.onFileUploadError(response.error)}if(!response.success){return}let entry={id:generateGUUID(),user:assignment.userId,date:(new Date).toString(),file:response.url};if(document.body.dataset["admin"]){entry.is_admin=true}if(this.el.classList.contains("is-assignment")){entry.is_assignment=true}else{entry.group=assignment.groupId;if(!entry.is_admin){entry.status="pending";api.notify("new_file_pending",{entry:entry,year:assignment.year,user:assignment.userId,assignment:assignment.docId})}}pushEntry(entry)}onFileUploadError(error){this.el.classList.remove("is-uploading");this.el.classList.add("is-error");this.errorEl.innerText=error}}class Entry{constructor(el){this.el=el;this.btDelete=el.querySelector(".entry__delete-bt");this.btDelete.addEventListener("click",this.onDeleteClicked.bind(this),false)}onDeleteClicked(ev){ev.preventDefault();let id=this.el.dataset["id"];let entries;let isAssignment=false;if(this.el.classList.contains("is-assignment")){entries=assignment.assignmentEntries;isAssignment=true}else{entries=assignment.entries}let index=-1;for(let i=0;i<entries.length;i++){if(!entries[i]){continue}if(entries[i].id==id){index=i;break}}if(index==-1){throw new Error("could not find entry "+id)}entries.splice(index,1);if(isAssignment){updateAssignmentEntries()}else{updateEntries()}}}class NewEntry{constructor(el){this.el=el;this.bt=el.querySelector(".entry__send-text");this.bt.addEventListener("click",this.onBtClicked.bind(this),false);this.input=el.querySelector(".new-entry-text");this.input.addEventListener("keypress",this.onInputKey.bind(this),false)}onBtClicked(ev){if(ev){ev.preventDefault()}if(!this.input.value){return}let entry={id:generateGUUID(),user:assignment.userId,date:(new Date).toString(),text:this.input.value};if(document.body.dataset["admin"]){entry.is_admin=true}if(this.el.classList.contains("is-assignment")){entry.is_assignment=true}else{entry.group=assignment.groupId}pushEntry(entry);this.input.value=""}onInputKey(ev){if(ev.key=="Enter"){this.onBtClicked()}}}const Groups=function(){let tpl=document.getElementById("edit-groups-tpl").innerHTML;let el=document.createElement("div");el.classList.add("modal-container");let hasChanged=false;function getGroupId(group){let gid="";for(let u of group){let firstName=u.split(".")[0];let lastName=u.split(".")[1];gid+=firstName[0]+lastName[0]+lastName.substr(1)+"_"}gid=gid.substr(0,gid.length-1);return gid}function preprocess(data){let groups=[];for(let i=0;i<data.assignment.groups.length;i++){let group={classes:[],users:[],name:"",id:""};let g=data.assignment.groups[i];for(let u of g){group.users.push(usersById[u]);let firstName=u.split(".")[0];let lastName=u.split(".")[1];group.name+=firstName[0].toUpperCase()+"."+lastName[0].toUpperCase()+lastName.substr(1,2)+" "}group.name=group.name.substr(0,group.name.length-1);group.id=getGroupId(g);if(group.id==assignment.groupId){group.classes.push("selected")}groups.push(group)}return groups}function edit(data){let groups=preprocess(data);el.innerHTML=ejs.render(tpl,{groups:groups});let groupsEl=el.querySelector(".groups-list");let current=null;let groupsEls=el.querySelectorAll(".group");for(let gEl of groupsEls){let avs=gEl.querySelectorAll(".avatar");for(let av of avs){av.addEventListener("drag",()=>{el.classList.add("dragging");av.classList.add("dragged-out");current=av},false);av.addEventListener("dragend",()=>{el.classList.remove("dragging");av.classList.remove("dragged-out");current=null},false)}gEl.addEventListener("dragover",ev=>{ev.preventDefault();if(current){gEl.classList.add("dragover")}},false);gEl.addEventListener("dragleave",()=>{gEl.classList.remove("dragover")},false);gEl.addEventListener("dragenter",ev=>{ev.preventDefault()},false);gEl.addEventListener("drop",ev=>{gEl.classList.remove("dragover");if(current&&current.parentNode!=gEl){hasChanged=true;let sourceId=Array.prototype.indexOf.call(groupsEl.children,current.parentNode);let sourceG=data.assignment.groups[sourceId];let userId=current.dataset["id"];let index=sourceG.indexOf(userId);sourceG.splice(index,1);if(sourceG.length==0){data.assignment.groups.splice(sourceId,1);current.parentNode.remove()}if(gEl.classList.contains("group-remove")){}else if(gEl.classList.contains("group-new")){data.assignment.groups.push([userId])}else{let destId=Array.prototype.indexOf.call(groupsEl.children,gEl);let destG=data.assignment.groups[destId];destG.push(userId)}edit(data)}},false)}mainEl.append(el);UserFinder.setup(el.querySelector(".student-finder"),userId=>{hasChanged=true;data.assignment.groups.push([userId]);edit(data)},false);let cancelBt=el.querySelector(".btn-cancel");cancelBt.addEventListener("click",ev=>{ev.preventDefault();el.remove()},false);let submitBt=el.querySelector('[value="submit"]');submitBt.addEventListener("click",onValidateClicked,false)}function onValidateClicked(ev){el.remove();if(hasChanged){mainEl.classList.add("loading");api.update(assignment.year,assignment.docId,assignment.data).then(data=>{load(true);hasChanged=false})}}return{edit:edit,preprocess:preprocess,getGroupId:getGroupId}}();class Assignment{constructor(){this.data=null;this.year=null;this.docId=null;this.groupId=null;this.userId=document.body.dataset["userId"];this.entries=[];this.assignmentEntries=[];this.el=document.createElement("div");this.el.classList.add("assignment");this.userId=document.body.dataset["userId"];this.tpls={};for(let tpl of["assignment-tpl","entry-tpl","new-entry-tpl"]){this.tpls[tpl]=document.getElementById(tpl).innerHTML}}render(data){this.data=data;let processed=this.processed=this.preprocess(data);let fn=ejs.compile(this.tpls["assignment-tpl"],{client:true});let html=fn(processed,null,(path,d)=>{let pTplData=this.preprocessTemplateData(path,d);if(pTplData){return ejs.render(this.tpls[path],pTplData)}});this.el.innerHTML=html;let groupEls=this.el.querySelectorAll(".groups .group");for(let el of groupEls){el.addEventListener("click",this.onGroupClicked.bind(this),false)}let editGroupsBtn=this.el.querySelector(".edit-groups-btn");if(editGroupsBtn){editGroupsBtn.addEventListener("click",()=>Groups.edit(this.data),false)}let entryEls=this.el.querySelectorAll(".entry-editable");for(let el of entryEls){new Entry(el)}let newEntryEls=this.el.querySelectorAll(".new-entry");for(let el of newEntryEls){new NewEntry(el)}let formEls=this.el.querySelectorAll(".box");for(let el of formEls){new UploadBox(el)}let rvbtn=this.el.querySelector(".review-btn");if(rvbtn){rvbtn.addEventListener("click",this.onReviewButtonClicked.bind(this),false)}}preprocess(data){this.user=usersById[this.userId];let groups=Groups.preprocess(data);let due;if(data.assignment["due-date"]){due=new Date(data.assignment["due-date"]).toISOString().substring(0,10)}let group;for(let g of groups){if(g.id==this.groupId){group=g;break}}let module=this.docId.split("_");module=module[0]+module[1];return{assignment:data.assignment,module:module,entries:data.entries,groups:groups,group:group?group.users.map(u=>u.name):null,user:this.user,users:users,due:due}}preprocessTemplateData(tpl,data){switch(tpl){case"new-entry-tpl":let classe=[];if(data.is_assignment){classe.push("is-assignment")}return{user:data.user,classes:classe,is_assignment:data.is_assignment};case"entry-tpl":if(data.group!=this.groupId&&!data.is_assignment){return}let date=new Date(data.date).toISOString().substring(0,10);let classes=[];let result={entry:data,date:date,classes:classes,user:usersById[data.user]};classes.push(data.status);if(data.user==this.userId){classes.push("entry-editable")}if(data.is_assignment){classes.push("is-assignment")}if(data.is_admin){classes.push("entry-align-alt")}if(data.file){result.filename=data.file.substr(data.file.lastIndexOf("/")+1);if(result.filename.length>30){let ext=result.filename.substr(result.filename.lastIndexOf("."));result.filename=result.filename.substr(0,30-ext.length);result.filename+="..."+ext}classes.push("file-entry")}return result;default:}return data}updateGroupsNumbers(data){let histogram={};for(let entry of data){if(histogram[entry.group]===undefined){histogram[entry.group]={h:0}}if(entry.status=="pending"){histogram[entry.group].pending=true}if(entry.status=="reviewed"){histogram[entry.group].reviewed=true}if(!entry.is_admin){histogram[entry.group].h++}}for(let h in histogram){let el=this.el.querySelector('.group[data-id="'+h+'"]');if(el){el.dataset["num"]=histogram[h].h;el.classList.remove("pending");if(histogram[h].pending){el.classList.add("pending")}el.classList.remove("reviewed");if(histogram[h].reviewed){el.classList.add("reviewed")}}}}updateAccepBtnVisibility(data){let btn=this.el.querySelector(".review-btn");if(btn){btn.style.display="none";for(let entry of data){if(entry.group==this.groupId&&entry.status=="pending"){btn.style.display="inline";return}}}}onReviewButtonClicked(ev){let entryId=this.el.querySelector(".file-entry.pending").dataset["id"];for(let i=0;i<this.entries.length;i++){if(this.entries[i].id==entryId){let url=`${this.year}/${this.docId}/entries/${i}/status`;let ref=database.ref(url);ref.set("reviewed");api.notify("entry_reviewed",{entry:this.entries[i],year:this.year,user:this.userId,assignment:this.docId});break}}}renderEntries(data,isAssignment){if(!data){data=[]}let el;if(isAssignment){this.assignmentEntries=data;el=this.el.querySelector(".assignment-entries .entries-list")}else{this.entries=data;el=this.el.querySelector(".assigned-entries .entries-list")}let tpl="entry-tpl";let render="";for(let d of data){if(!d){continue}d.is_assignment=isAssignment;let processed=this.preprocessTemplateData(tpl,d);if(processed){render+=ejs.render(this.tpls[tpl],processed)}}el.innerHTML=render;this.updateGroupsNumbers(data);this.updateAccepBtnVisibility(data);let groupNames=document.body.querySelector(".group-names > :first-child");let groups=Groups.preprocess(this.data);for(let g of groups){if(g.id==this.groupId){groupNames.innerHTML=g.users.map(u=>u.name).join(", ");break}}let entryEls=el.querySelectorAll(".entry-editable");for(let eel of entryEls){new Entry(eel)}}onGroupClicked(ev){let groupId=ev.currentTarget.dataset["id"];setNav(this.year,this.docId,groupId)}}let navEl=document.body.querySelector("nav");function setupNav(){let els=navEl.querySelectorAll("li a");for(let a of els){a.addEventListener("click",onNavItemClicked,false)}}function onNavItemClicked(ev){ev.preventDefault();let els=navEl.querySelectorAll("li a");for(let a of els){a.classList.remove("selected")}let a=ev.currentTarget;a.classList.add("selected");if(window.innerWidth<800){appEl.classList.add("fold")}setNav(a.dataset["year"],a.dataset["assignmentId"])}setupNav();let newAEl=document.querySelector(".app nav .btn-new");if(newAEl){newAEl.addEventListener("click",startNewAssignment)}function checkAssignment(){let formEl=mainEl.querySelector(".new-assignment-form");let courseEl=formEl.querySelector('[name="course-id"]');let groupEl=formEl.querySelector('[name="class-id"]');let nameEl=formEl.querySelector('[name="assignment-name"]');let createBtn=formEl.querySelector('[value="submit"]');courseEl.disabled=true;nameEl.classList.add("disabled");createBtn.classList.add("disabled");if(groupEl.value==""){return}courseEl.disabled=false;if(courseEl.value==""){return}nameEl.classList.remove("disabled");if(nameEl.value.length==0){return}createBtn.classList.remove("disabled")}function startNewAssignment(){let aEl=mainEl.querySelector(".assignment");if(aEl){aEl.classList.add("hidden")}let formEl=mainEl.querySelector(".new-assignment-form");formEl.classList.remove("hidden");let cancelBtn=formEl.querySelector(".btn-cancel");cancelBtn.addEventListener("click",ev=>{ev.preventDefault();if(aEl){aEl.classList.remove("hidden")}formEl.classList.add("hidden")});let courseEl=formEl.querySelector('[name="course-id"]');let groupEl=formEl.querySelector('[name="class-id"]');groupEl.addEventListener("change",ev=>{let group=groupEl.value;for(let el of courseEl.children){if(el.value=="other"||el.value==""){continue}el.style.display=el.value.indexOf(group)!=-1?"":"none"}courseEl.value="";checkAssignment()});courseEl.addEventListener("change",checkAssignment,false);let nameEl=formEl.querySelector('[name="assignment-name"]');nameEl.addEventListener("change",checkAssignment,false);let btEl=mainEl.querySelector('.new-assignment-form [value="submit"]');btEl.addEventListener("click",()=>{formEl.style.display="none";document.body.classList.add("loading")},false)}"use strict";const UserFinder=function(){let el=null;let users=null;let year=document.body.dataset["year"];let template=document.getElementById("user-card-tpl");if(template){template=template.innerHTML}let inputEl;let listEl;let callback=null;function onLiClicked(evt){if(callback){let uid=evt.currentTarget.dataset["id"];callback(uid)}inputEl.value=null;hideList()}function resetFinder(){inputEl.value=""}function onInputFocus(evt){resetFinder();showList()}function onInputBlur(evt){hideList()}function onInputChange(evt){const val=inputEl.value;filterList(val)}function showList(){listEl.style.display="block";filterList(inputEl.value)}function hideList(){listEl.style.display="none"}function filterList(text){text=text.toLowerCase();let i=0;while(listEl.hasChildNodes()){listEl.removeChild(listEl.lastChild)}for(let u of users){const name=u.name.toLowerCase();if(i<5&&name.indexOf(text)!=-1){let output=ejs.render(template,u);let li=document.createElement("li");li.classList.add("user");li.addEventListener("click",onLiClicked,false);li.innerHTML=output;li.dataset["id"]=u.id;li.dataset["name"]=u.name;listEl.appendChild(li);i++}}}function setupFinder(){listEl=el.querySelector("ul.student-list");inputEl=el.querySelector("input.student-input");inputEl.addEventListener("focus",onInputFocus);inputEl.addEventListener("input",onInputChange)}function setup(containerEl,cb){if(!template){return}el=containerEl;callback=cb;qwest.get("/static/data/"+year+"/users.json").then(function(xhr,data){users=data;for(let u of users){if(u.img=="?"){u.img="/static/res/user.svg"}else{u.img=USER_PHOTOS_URL+u.img}usersById[u.id]={id:u.id,img:u.img,name:u.name}}setupFinder()}).catch(function(e){console.error(e)})}return{setup:setup,users:users}}();"use strict";const USER_PHOTOS_URL=document.body.dataset["usersImgPrefix"];let appEl=document.querySelector(".app");let mainEl=appEl.querySelector(".app main");let assignment=new Assignment;let assignmentEntriesRef;let entriesRef;let database=firebase.database();let usersById={};for(let u in users){if(u){let user=usersById[u]=users[u];user.id=u;if(user.img=="?"){user.img="/static/res/user.svg"}else{user.img=USER_PHOTOS_URL+user.img}}}function setup(){let avatarEl=document.querySelector(".avatar");avatarEl.addEventListener("click",()=>window.location.href="/logout");window.addEventListener("popstate",onPopState,false);window.onpopstate=onPopState;let year=document.body.dataset["year"];let docId=document.body.dataset["assignment"];let groupId=document.body.dataset["group"];if(!docId){appEl.classList.remove("fold");mainEl.classList.remove("loading");mainEl.classList.add("no-assignment-selected");return}setNav(year,docId,groupId)}function load(force){mainEl.classList.remove("no-assignment-selected");assignment.year=document.body.dataset["year"];if(!assignment.year){return}assignment.groupId=document.body.dataset["group"];if(!force&&assignment.docId&&document.body.dataset["assignment"]==assignment.docId){assignment.renderEntries(assignment.entries,false);let gps=document.body.querySelectorAll(".groups .group");if(gps.length){for(let g of gps){if(g.dataset["id"]==assignment.groupId){g.classList.add("selected")}else{g.classList.remove("selected")}}}return}else{assignment.docId=document.body.dataset["assignment"];if(!assignment.docId){return}}mainEl.classList.add("loading");let url=`/api/a/${assignment.year}/${assignment.docId}`;qwest.get(url).then((xhr,data)=>{data=JSON.parse(data)[assignment.year][assignment.docId];assignment.render(data);connectFirebase();if(!assignment.el.parentNode){mainEl.append(assignment.el)}if(window.innerWidth>800){appEl.classList.remove("fold")}let userId=document.body.dataset.userId;if(!document.body.dataset.admin){let g=getUserGroup(userId,data);if(assignment.groupId!=g){setNav(assignment.year,document.body.dataset["assignment"],g)}}}).catch(e=>console.error(e))}function connectFirebase(){assignmentEntriesRef=database.ref(`${assignment.year}/${assignment.docId}/assignment/entries`);assignmentEntriesRef.off();assignmentEntriesRef.on("value",data=>{mainEl.classList.remove("loading");assignment.renderEntries(data.val(),true)});entriesRef=database.ref(`${assignment.year}/${assignment.docId}/entries`);entriesRef.off();entriesRef.on("value",data=>{assignment.renderEntries(data.val(),false)})}function getUserGroup(userId,data){for(let i=0;i<data.assignment.groups.length;i++){const g=data.assignment.groups[i];for(let u of g){if(u==userId){return Groups.getGroupId(g)}}}return-1}function pushEntry(entry){if(entry.is_assignment){assignment.assignmentEntries.push(entry);updateAssignmentEntries()}else{assignment.entries.push(entry);updateEntries()}}function updateAssignmentEntries(){assignmentEntriesRef.set(assignment.assignmentEntries)}function updateEntries(){entriesRef.set(assignment.entries)}function onPopState(ev){setNav(ev.state.year,ev.state.assignment,ev.state.group)}function setNav(year,assignment,group){document.body.dataset["year"]=year;document.body.dataset["assignment"]=assignment;if(group){document.body.dataset["group"]=group}else{delete document.body.dataset["group"]}let state={year:year,assignment:assignment,group:group};let url=`/a/${year}/${assignment}`+(group?"/"+group:"");window.history.pushState(state,url,url);window.parent.postMessage({a:state,b:url,c:url},"*");load()}let foldEl=document.body.querySelector("#toggle-menu");foldEl.addEventListener("click",()=>appEl.classList.toggle("fold"),false);setup();window.addEventListener("resize",()=>{if(window.innerWidth<800&&!appEl.classList.contains("fold")){appEl.classList.add("fold")}else if(window.innerWidth>800&&appEl.classList.contains("fold")){appEl.classList.remove("fold")}});MobileDragDrop.polyfill({dragImageTranslateOverride:MobileDragDrop.scrollBehaviourDragImageTranslateOverride});